<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>MUCHI NOTE</title>
  <style>
    /* === Global layout & background (Glassmorphism) === */
    :root {
      /* === Reference Image Color Palette === */
      --bg-gradient: linear-gradient(135deg, #d5dce3 0%, #eef2f5 100%);
      --panel-bg: rgba(240, 244, 248, 0.6);
      /* Slightly more transparent/lighter */
      --text-main: #364049;
      --text-sub: #8A93A1;

      /* Pastel Card Colors */
      --c-yellow: #FAF2B1;
      --c-green: #DFF5E3;
      --c-sky: #DDEAF9;
      --c-pink: #F5D5D5;
      --c-purple: #DCE1FA;

      /* Shadows (Soft Neumorphism) */
      --shadow-soft: 0 10px 30px -5px rgba(0, 0, 0, 0.08), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
      --shadow-inset: inset 0 2px 4px 0 rgba(0, 0, 0, 0.03);

      /* Typography */
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: var(--bg-gradient);
      color: var(--text-main);
      min-height: 100vh;
      /* Custom Scrollbar */
      scrollbar-width: thin;
      scrollbar-color: #CBD5E1 transparent;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    /* === Main Glass Panel Wrapper === */
    .main-glass-panel {
      width: 100%;
      max-width: 98%;
      /* Fluid width */
      background: rgba(255, 255, 255, 0.18);
      border-radius: 32px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(24px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 20px 32px;
      background: rgba(255, 255, 255, 0.1);
      color: #111827;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    header .hint {
      font-size: 13px;
      opacity: 0.7;
      font-weight: 500;
    }

    .top-bar {
      padding: 16px 32px;
      background: transparent;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .month-title {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.5px;
    }

    /* === Buttons (Neo-brutal pill style) === */
    .btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.35);
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
      cursor: pointer;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.1);
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.15);
    }

    .btn-green {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
      color: #065f46;
    }

    .btn-green:hover {
      background: rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.8);
    }

    /* ì˜¤ëŠ˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .btn-today {
      border-color: #3b82f6;
      color: #1d4ed8;
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      margin-left: 4px;
    }

    .btn-today:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: #2563eb;
      color: #1e40af;
    }

    /* ë…„/ì›” ì„ íƒ í† ê¸€ UI */
    .month-picker {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 180px;
    }

    .month-display {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.3);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .month-display:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .month-caret {
      font-size: 10px;
      color: #6b7280;
      transition: transform 0.15s;
    }

    .month-display.open .month-caret {
      transform: rotate(180deg);
    }

    .month-dropdown {
      position: absolute;
      top: 110%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 4px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 1);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      font-size: 12px;
      z-index: 20;
      display: none;
      min-width: 240px;
    }

    .month-dropdown.open {
      display: block;
    }

    .ym-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .ym-year-label {
      font-weight: 700;
      font-size: 14px;
    }

    .ym-year-btn {
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.5);
      background: rgba(255, 255, 255, 0.5);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .ym-year-btn:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .ym-month-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }

    .ym-month-btn {
      border-radius: 999px;
      border: 1px solid rgba(229, 231, 235, 0.5);
      background: rgba(255, 255, 255, 0.5);
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
      text-align: center;
    }

    .ym-month-btn:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(191, 219, 254, 0.8);
    }

    .ym-month-btn.active {
      background: #3b82f6;
      border-color: #2563eb;
      color: #ffffff;
    }

    .search-wrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-input {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.4);
      min-width: 200px;
      transition: all 0.2s;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.8);
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .calendar-wrapper {
      flex: 1;
      padding: 24px 32px 40px;
      background: transparent;
    }

    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 700;
      color: rgba(17, 24, 39, 0.6);
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* ì£¼ë³„ ë ˆì´ì•„ì›ƒ + ì ‘ê¸°/í¼ì¹˜ê¸° */
    .calendar-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* === Week Row (Glass Card) === */
    .week-row {
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.95);
      /* Nearly opaque */
      padding: 8px 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.15);
      /* Floating shadow */
    }

    .week-row.current-week {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3), 0 10px 30px rgba(59, 130, 246, 0.15);
      background: rgba(255, 255, 255, 0.25);
    }

    .week-row-outside {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .week-row-outside .week-row-title {
      color: rgba(156, 163, 175, 0.8);
      font-weight: 600;
    }

    .week-row-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
      color: rgba(107, 114, 128, 0.9);
      padding: 4px 12px;
      margin: 0;
      cursor: pointer;
      transition: background 0.15s;
    }

    .week-row-header:hover {
      background: rgba(59, 130, 246, 0.12);
      /* Soft Blue for visibility */
      border-radius: 99px;
      color: #2563eb;
      /* Darker blue text */
    }

    .week-row-title {
      font-weight: 700;
    }

    .week-row-body {
      display: grid;
      grid-template-columns: repeat(7, minmax(150px, 1fr));
      gap: 12px;
    }

    .week-row.collapsed .week-row-body {
      display: none;
    }

    /* === Day Cells (Glass Chips) === */
    .day-cell {
      min-height: 160px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.95);
      /* Nearly opaque */
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.15);
      /* Floating shadow */
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin: 4px;
      border-radius: 16px;
    }

    .day-cell:last-child {
      border-right: 1px solid rgba(255, 255, 255, 0.9);
    }

    .day-cell:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.2);
      background: rgba(255, 255, 255, 1);
      z-index: 20;
    }

    .day-cell.today {
      border: 2px solid #3b82f6;
      background: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .day-cell.other-month {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      opacity: 0.7;
    }

    .day-cell.other-month .day-number,
    .day-cell.other-month .day-meta {
      color: rgba(156, 163, 175, 0.8);
    }

    .day-cell.drop-target {
      outline: 2px solid #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      background: rgba(224, 242, 254, 0.6);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 10px;
    }

    .day-number {
      font-size: 14px;
      font-weight: 700;
    }

    .day-number.sun {
      color: #ef4444;
    }

    .day-number.sat {
      color: #2563eb;
    }

    .day-meta {
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
    }

    .day-cell.today .day-meta {
      background: #3b82f6;
      color: white;
      padding: 2px 8px;
      border-radius: 99px;
    }

    .day-body {
      position: relative;
      flex: 1;
      padding-top: 4px;
    }

    .day-empty-hint {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 10px;
      color: rgba(107, 114, 128, 0.5);
      pointer-events: none;
    }

    /* === Cards === */
    .card {
      position: relative;
      margin-bottom: 8px;
      padding: 8px 10px 8px 20px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      font-size: 12px;
      line-height: 1.4;
      cursor: default;
      overflow-wrap: break-word;
      min-height: 40px;
      font-weight: 500;
      backdrop-filter: blur(4px);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: scale(1.02);
      z-index: 5;
    }

    .card.selected {
      border: 2px solid #3b82f6 !important;
      background: rgba(219, 234, 254, 0.9) !important;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      z-index: 10;
    }

    .card-placeholder {
      height: 3px;
      margin: 2px 0;
      border-radius: 2px;
      background: rgba(59, 130, 246, 0.6);
    }

    .card.color-yellow {
      background: rgba(254, 240, 138, 0.85);
      border-color: rgba(253, 224, 71, 0.6);
    }

    .card.color-green {
      background: rgba(187, 247, 208, 0.85);
      border-color: rgba(134, 239, 172, 0.6);
    }

    .card.color-pink {
      background: rgba(254, 205, 211, 0.85);
      border-color: rgba(253, 164, 175, 0.6);
    }

    .card.done {
      background: rgba(229, 231, 235, 0.6);
      border-color: transparent;
      text-decoration: line-through;
      color: #9ca3af;
      box-shadow: none;
    }

    .card-handle {
      position: absolute;
      top: 6px;
      bottom: 6px;
      left: 6px;
      width: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.2);
      cursor: grab;
    }

    .card-content {
      white-space: pre-wrap;
      position: relative;
    }

    .card-content:empty::before {
      content: attr(data-placeholder);
      color: rgba(156, 163, 175, 0.8);
      pointer-events: none;
    }

    .card-content:focus:empty::before {
      content: "";
    }

    .card-toolbar {
      position: absolute;
      top: 6px;
      right: 8px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 2;
      max-width: 80px;
    }

    .card:hover .card-toolbar {
      opacity: 1;
    }

    .card-btn {
      border: none;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 999px;
      font-size: 9px;
      padding: 0 8px;
      min-width: 40px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .card-btn:hover {
      background: #ffffff;
      font-weight: 600;
    }

    .help-bar {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 16px;
      padding: 12px 24px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      font-size: 13px;
      color: #4b5563;
      backdrop-filter: blur(10px);
      max-width: 1400px;
      width: 100%;
    }

    .debug-hint {
      font-size: 11px;
      color: rgba(107, 114, 128, 0.8);
      margin-left: 4px;
    }

    /* === Search Scope Toggles === */
    .search-scope-toggles {
      display: flex;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 999px;
      padding: 4px;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .scope-btn {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scope-btn.active {
      background: #ffffff;
      color: #3b82f6;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* === Search Highlights & Error === */
    .card.search-hit {
      outline: 2px solid #f97316 !important;
      background: rgba(255, 237, 213, 0.9) !important;
      /* Orange-100 */
      transition: background 0.5s ease, outline 0.5s ease;
    }

    .search-input.error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
      animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
    }

    @keyframes shake {

      10%,
      90% {
        transform: translate3d(-1px, 0, 0);
      }

      20%,
      80% {
        transform: translate3d(2px, 0, 0);
      }

      30%,
      50%,
      70% {
        transform: translate3d(-4px, 0, 0);
      }

      40%,
      60% {
        transform: translate3d(4px, 0, 0);
      }
    }

    /* === Toast Notification === */
    .toast-container {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: rgba(31, 41, 55, 0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      animation: toast-in 0.3s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes toast-in {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes toast-out {
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main-glass-panel">
      <header>
        <div>MUCHI NOTE</div>
        <div class="hint">
          ğŸ’¡ ë‚ ì§œ ë”ë¸”í´ë¦­ = ìƒˆ ì¹´ë“œ Â· ì¹´ë“œ í´ë¦­ = ìˆ˜ì • Â· ì¹´ë“œ ë”ë¸”í´ë¦­ = ì™„ë£Œ í† ê¸€ Â·
          ë“œë˜ê·¸ë¡œ ì´ì›” Â· ì£¼ ì œëª© í´ë¦­ = ì£¼ë³„ ì ‘ê¸°/í¼ì¹˜ê¸° Â· ì¹´ë“œ ìƒ‰ìƒ ë²„íŠ¼ìœ¼ë¡œ ìŠ¬ë¡¯ ìƒ‰ ë°”ê¾¸ê¸°
        </div>
      </header>

      <div class="top-bar">
        <button class="btn" id="prevMonth">&lt; ì´ì „ ë‹¬</button>
        <div class="month-picker">
          <button class="month-display" id="monthPickerToggle" type="button">
            <span class="month-title" id="monthTitle"></span>
          </button>
          <div class="month-dropdown" id="monthDropdown">
            <div class="ym-header">
              <button type="button" class="ym-year-btn" id="ymPrevYear">â€¹</button>
              <span class="ym-year-label" id="ymYearLabel"></span>
              <button type="button" class="ym-year-btn" id="ymNextYear">â€º</button>
            </div>
            <div class="ym-month-grid">
              <button type="button" class="ym-month-btn" data-month="0">1ì›”</button>
              <button type="button" class="ym-month-btn" data-month="1">2ì›”</button>
              <button type="button" class="ym-month-btn" data-month="2">3ì›”</button>
              <button type="button" class="ym-month-btn" data-month="3">4ì›”</button>
              <button type="button" class="ym-month-btn" data-month="4">5ì›”</button>
              <button type="button" class="ym-month-btn" data-month="5">6ì›”</button>
              <button type="button" class="ym-month-btn" data-month="6">7ì›”</button>
              <button type="button" class="ym-month-btn" data-month="7">8ì›”</button>
              <button type="button" class="ym-month-btn" data-month="8">9ì›”</button>
              <button type="button" class="ym-month-btn" data-month="9">10ì›”</button>
              <button type="button" class="ym-month-btn" data-month="10">11ì›”</button>
              <button type="button" class="ym-month-btn" data-month="11">12ì›”</button>
            </div>
          </div>
        </div>
        <button class="btn" id="nextMonth">ë‹¤ìŒ ë‹¬ &gt;</button>
        <!-- ì˜¤ëŠ˜ ë²„íŠ¼ ì¶”ê°€ -->
        <button class="btn btn-today" id="todayBtn">ì˜¤ëŠ˜</button>

        <div class="search-wrap">
          <div class="search-scope-toggles">
            <button class="scope-btn active" id="scopeMonth">ì´ë²ˆ ë‹¬</button>
            <button class="scope-btn" id="scopeAll">ì „ì²´</button>
          </div>
          <input class="search-input" id="searchInput" type="text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
          <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
          <button class="btn btn-green" id="backupBtn">ë°ì´í„° ë°±ì—…</button>
        </div>
      </div>

      <div class="calendar-wrapper">
        <div class="weekday-row">
          <div>ì¼</div>
          <div>ì›”</div>
          <div>í™”</div>
          <div>ìˆ˜</div>
          <div>ëª©</div>
          <div>ê¸ˆ</div>
          <div>í† </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="help-bar">
      âœï¸ ë‚ ì§œ ì¹¸ <b>ë”ë¸”í´ë¦­</b> â†’ ìƒˆ ì¹´ë“œ Â· ì¹´ë“œ <b>í´ë¦­</b> â†’ ë‚´ìš© ìˆ˜ì • Â· ì¹´ë“œ <b>ë”ë¸”í´ë¦­</b> â†’ ì™„ë£Œ/í•´ì œ Â·
      ì¹´ë“œ <b>ì™¼ìª½ ë§‰ëŒ€ ë“œë˜ê·¸</b> â†’ ë‹¤ë¥¸ ë‚ ì§œë¡œ ì´ë™ Â· <b>ì£¼ ì œëª© í´ë¦­</b>ìœ¼ë¡œ ì£¼ë³„ ì ‘ê¸°/í¼ì¹˜ê¸° Â· ì¹´ë“œ íˆ´ë°”ì˜ <b>ìƒ‰ìƒ</b> ë²„íŠ¼ìœ¼ë¡œ ìŠ¬ë¡¯ ìƒ‰ìƒ ë³€ê²½
      <span class="debug-hint">(ğŸ’¾ / ğŸ“¥ ë²„íŠ¼ì´ ë™ì‘í•˜ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì € ì½˜ì†”ì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í•¨ê»˜ í™•ì¸í•´ ì£¼ì„¸ìš”)</span>
    </div>
  </div>

  <script>
    // ==== MUCHI NOTE v3 â€“ ë‹¨ìˆœí•˜ê³  í™•ì‹¤í•œ ì €ì¥ + Airtable ì—°ë™ ë²„ì „ ====

    const STORAGE_KEY = "muchi-note-safe-v3";

    // ==== Airtable ì—°ë™ ì„¤ì • ====
    // ì‹¤ì œ ì‚¬ìš©í•  ë•Œ AIRTABLE_TOKEN ê°’ì— pat ë¡œ ì‹œì‘í•˜ëŠ” í† í°ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
    const AIRTABLE_BASE_ID = "app8KHGcgFezjsSHP"; // ì´ë¯¸ í™•ì¸í•œ Base ID
    const AIRTABLE_TABLE_NAME = "cards";          // í…Œì´ë¸” ì´ë¦„ (cards)
    const AIRTABLE_TOKEN = "ì—¬ê¸°ì—_ë„¤_Airtable_í† í°_ë¶™ì—¬ë„£ê¸°"; // ì´ ë¬¸ìì—´ì„ pat... í† í°ìœ¼ë¡œ êµì²´

    let current = new Date();
    current.setDate(1);

    const monthTitle = document.getElementById("monthTitle");
    const monthPickerToggle = document.getElementById("monthPickerToggle");
    const monthDropdown = document.getElementById("monthDropdown");
    const ymYearLabel = document.getElementById("ymYearLabel");
    const ymPrevYear = document.getElementById("ymPrevYear");
    const ymNextYear = document.getElementById("ymNextYear");
    const ymMonthButtons = document.querySelectorAll(".ym-month-btn");
    let pickerYear = current.getFullYear();

    const calendarGrid = document.getElementById("calendarGrid");
    const prevBtn = document.getElementById("prevMonth");
    const nextBtn = document.getElementById("nextMonth");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const backupBtn = document.getElementById("backupBtn");
    const airtableSaveBtn = document.getElementById("airtableSaveBtn");
    const airtableLoadBtn = document.getElementById("airtableLoadBtn");
    const todayBtn = document.getElementById("todayBtn");

    const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
    const weekdayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    const CARD_COLORS = ["default", "yellow", "green", "pink"];

    let state = { nextId: 1, cards: {}, weekVisibility: {} };
    let draggingCard = null; // (Legacy)
    let draggingCards = [];
    let dragPlaceholder = null;

    function toggleSelection(card) {
      card.classList.toggle("selected");
    }

    function clearSelection() {
      document.querySelectorAll(".card.selected").forEach(c => c.classList.remove("selected"));
    }

    // ===== ê³µí†µ ìœ í‹¸ =====
    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function formatMonthKey(year, monthIndex) {
      return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
    }

    function updateMonthTitle() {
      monthTitle.textContent = `${current.getFullYear()}ë…„ ${monthNames[current.getMonth()]}`;
      if (ymYearLabel) ymYearLabel.textContent = `${pickerYear}ë…„`;
    }

    function toggleMonthDropdown() {
      if (!monthDropdown || !monthPickerToggle) return;
      const willOpen = !monthDropdown.classList.contains("open");
      if (willOpen) {
        pickerYear = current.getFullYear();
        monthDropdown.classList.add("open");
        monthPickerToggle.classList.add("open");
        if (ymYearLabel) ymYearLabel.textContent = `${pickerYear}ë…„`;
      } else {
        monthDropdown.classList.remove("open");
        monthPickerToggle.classList.remove("open");
      }
    }
    function closeMonthDropdown() {
      if (!monthDropdown || !monthPickerToggle) return;
      monthDropdown.classList.remove("open");
      monthPickerToggle.classList.remove("open");
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          if (parsed.cards && typeof parsed.cards === "object") state.cards = parsed.cards;
          if (parsed.weekVisibility && typeof parsed.weekVisibility === "object") state.weekVisibility = parsed.weekVisibility;
          if (typeof parsed.nextId === "number" && parsed.nextId > 0) state.nextId = parsed.nextId;
        }
      } catch (e) {
        console.error("loadState error", e);
        state = { nextId: 1, cards: {}, weekVisibility: {} };
      }
    }
    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("saveState error", e);
      }
    }

    function getCardsForDate(dateKey) {
      const list = state.cards[dateKey];
      return Array.isArray(list) ? list : [];
    }
    function ensureCardList(dateKey) {
      if (!Array.isArray(state.cards[dateKey])) state.cards[dateKey] = [];
      return state.cards[dateKey];
    }

    function upsertCard(dateKey, cardObj) {
      const list = ensureCardList(dateKey);
      const id = cardObj.id;
      const idx = list.findIndex(c => c.id === id);
      if (idx >= 0) list[idx] = cardObj; else list.push(cardObj);
      saveState();
    }

    function deleteCardFromState(dateKey, id) {
      const list = state.cards[dateKey];
      if (!Array.isArray(list)) return false;
      const initLen = list.length;
      state.cards[dateKey] = list.filter(c => c.id !== id);
      const deleted = state.cards[dateKey].length < initLen;
      if (state.cards[dateKey].length === 0) delete state.cards[dateKey];
      if (deleted) saveState();
      return deleted;
    }

    function applyCardColorClass(card, colorKey) {
      card.classList.remove("color-yellow", "color-green", "color-pink");
      if (colorKey === "yellow") card.classList.add("color-yellow");
      else if (colorKey === "green") card.classList.add("color-green");
      else if (colorKey === "pink") card.classList.add("color-pink");
    }

    // ë±ƒì§€ ì—…ë°ì´íŠ¸ í—¬í¼
    function updateDayBadge(dateKey) {
      const cell = document.querySelector(`.day-cell[data-date="${dateKey}"]`);
      if (!cell) return;
      const metaEl = cell.querySelector(".day-meta");
      if (!metaEl) return;

      // ì˜¤ëŠ˜ì¸ì§€ í™•ì¸
      const isToday = cell.classList.contains("today");

      if (isToday) {
        metaEl.textContent = "ì˜¤ëŠ˜";
      } else {
        metaEl.textContent = "";
      }
    }

    // DOM ì¹´ë“œ â†’ state ë°˜ì˜
    function syncOneCardFromDom(card) {
      const dateKey = card.dataset.date;
      const idStr = card.dataset.cardId;
      if (!dateKey || !idStr) return;
      const id = Number(idStr);
      if (!Number.isFinite(id)) return;

      const content = card.querySelector(".card-content");
      const text = content ? content.textContent : "";
      const done = card.classList.contains("done");
      const color = card.dataset.color || "default";

      const obj = { id, text, done, color };
      upsertCard(dateKey, obj);
    }

    // í˜„ì¬ ë‹¬ í™”ë©´ ì „ì²´ë¥¼ DOM ê¸°ì¤€ìœ¼ë¡œ stateì— ë§ì¶”ëŠ” ì•ˆì „ ì €ì¥
    function syncCurrentMonthFromDom() {
      const dayCells = document.querySelectorAll(".day-cell[data-date]");
      dayCells.forEach(cell => {
        const dateKey = cell.dataset.date;
        if (!dateKey) return;
        const cards = Array.from(cell.querySelectorAll(".card"));
        if (cards.length === 0) {
          delete state.cards[dateKey];
          return;
        }
        const list = [];
        cards.forEach(card => {
          const idStr = card.dataset.cardId;
          const id = Number(idStr);
          if (!Number.isFinite(id)) return;
          const content = card.querySelector(".card-content");
          const text = content ? content.textContent : "";
          const done = card.classList.contains("done");
          const color = card.dataset.color || "default";
          list.push({ id, text, done, color });
        });
        state.cards[dateKey] = list;
      });
      saveState();
    }

    function makeEditable(card) {
      const content = card.querySelector(".card-content");
      if (!content || content.isContentEditable) return;

      content.contentEditable = "true";
      content.focus();
      const range = document.createRange();
      range.selectNodeContents(content);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);

      function onBlur() {
        content.removeEventListener("blur", onBlur);
        content.removeEventListener("keydown", onKey);
        content.contentEditable = "false";
        syncOneCardFromDom(card);
      }
      function onKey(e) {
        if (e.key === "Escape") {
          e.preventDefault();
          content.blur();
        }
      }
      content.addEventListener("blur", onBlur);
      content.addEventListener("keydown", onKey);
    }

    function createCard(container, cardData, options) {
      const opts = Object.assign({ autoEdit: true, fromState: false }, options || {});
      const hint = container.querySelector(".day-empty-hint");
      if (hint) hint.style.display = "none";

      const card = document.createElement("div");
      card.className = "card";
      const handle = document.createElement("div");
      handle.className = "card-handle";
      const content = document.createElement("div");
      content.className = "card-content";
      content.dataset.placeholder = "ìƒˆ í•  ì¼ì„ ì ì–´ë³´ì„¸ìš”";

      const toolbar = document.createElement("div");
      toolbar.className = "card-toolbar";
      const btnColor = document.createElement("button");
      btnColor.className = "card-btn card-btn-color";
      btnColor.textContent = "ìƒ‰ìƒ";
      const btnDelete = document.createElement("button");
      btnDelete.className = "card-btn card-btn-delete";
      btnDelete.textContent = "ì‚­ì œ";
      toolbar.appendChild(btnColor);
      toolbar.appendChild(btnDelete);

      let text = (cardData && cardData.text) || "";
      let done = !!(cardData && cardData.done);
      let color = (cardData && cardData.color) || "default";
      let id = (cardData && typeof cardData.id === "number") ? cardData.id : null;
      if (!Number.isFinite(id) || id <= 0) id = state.nextId++;

      card.dataset.cardId = String(id);
      card.id = "card-" + id;
      card.dataset.color = color;
      applyCardColorClass(card, color);
      content.textContent = text || "";

      const dayCell = container.closest(".day-cell");
      if (dayCell && dayCell.dataset.date) {
        const key = dayCell.dataset.date;
        card.dataset.date = key;
        if (!opts.fromState) {
          upsertCard(key, { id, text, done, color });
        }
      }

      if (done) card.classList.add("done");

      card.appendChild(handle);
      card.appendChild(toolbar);
      card.appendChild(content);
      container.appendChild(card);

      card.addEventListener("click", (e) => {
        // Shift + Click: ë‹¤ì¤‘ ì„ íƒ
        if (e.shiftKey) {
          e.stopPropagation();
          toggleSelection(card);
          return;
        }

        // ì¼ë°˜ í´ë¦­: í¸ì§‘ ëª¨ë“œ (ê¸°ì¡´ ë™ì‘)
        // ë‹¨, ìš”êµ¬ì‚¬í•­: "ë‹¨ì¼ í´ë¦­: ê¸°ì¡´ì²˜ëŸ¼ ì¹´ë“œ ë‚´ìš© í¸ì§‘(ì—ë””íŠ¸) ì§„ì… (ë‹¤ì¤‘ ì„ íƒê³¼ ìƒê´€ ì—†ìŒ)"
        // "ì„ íƒ ìƒíƒœì—ì„œ ì„ íƒë˜ì§€ ì•Šì€ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•  ê²½ìš°: ì´ì „ ì„ íƒì„ ëª¨ë‘ í•´ì œí•˜ê³  ê·¸ ì¹´ë“œ í•˜ë‚˜ë§Œ ë“œë˜ê·¸"
        // ì—¬ê¸°ì„œ ì„ íƒì„ í•´ì œí•´ì•¼ í• ê¹Œ? "ë¹ˆ ì˜ì—­ í´ë¦­ ë˜ëŠ” Esc í‚¤: ëª¨ë“  ì¹´ë“œ ì„ íƒ í•´ì œ"ë¼ê³  í–ˆìœ¼ë¯€ë¡œ,
        // ì¹´ë“œ í´ë¦­ ì‹œì—ëŠ” ì„ íƒì„ í•´ì œí•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì•ˆì „í•´ ë³´ì„. (í¸ì§‘í•˜ë©´ì„œ ì„ íƒ ìœ ì§€ ê°€ëŠ¥?)
        // í•˜ì§€ë§Œ ë³´í†µ í¸ì§‘ ëª¨ë“œ ë“¤ì–´ê°€ë©´ ì„ íƒ í•´ì œí•˜ëŠ”ê²Œ ìì—°ìŠ¤ëŸ¬ì›€.
        // ì¼ë‹¨ ìš”êµ¬ì‚¬í•­ëŒ€ë¡œ "ë¹ˆ ì˜ì—­ í´ë¦­" ì‹œ í•´ì œí•˜ë¯€ë¡œ ì—¬ê¸°ì„  ë†”ë‘ .

        const contentEl = card.querySelector(".card-content");
        if (!contentEl || contentEl.isContentEditable) return;
        makeEditable(card);
      });
      card.addEventListener("dblclick", (e) => {
        e.stopPropagation();
        card.classList.toggle("done");
        syncOneCardFromDom(card);
        // ì™„ë£Œ ìƒíƒœ ë³€ê²½ ì‹œ ë±ƒì§€ ì—…ë°ì´íŠ¸
        const dKey = card.dataset.date;
        if (dKey) updateDayBadge(dKey);
      });

      btnDelete.addEventListener("click", (e) => {
        e.stopPropagation();
        const dateKey = card.dataset.date;
        const idStr = card.dataset.cardId;
        const parent = card.parentElement;
        card.remove();
        if (dateKey && idStr) {
          const id = Number(idStr);
          if (Number.isFinite(id)) {
            // 1ì°¨ ì‹œë„: í•´ë‹¹ ë‚ ì§œì—ì„œ ì‚­ì œ
            let deleted = deleteCardFromState(dateKey, id);

            // 2ì°¨ ì‹œë„: ì‹¤íŒ¨ ì‹œ ì „ì²´ ê²€ìƒ‰í•´ì„œ ì‚­ì œ (ì•ˆì „ì¥ì¹˜)
            if (!deleted) {
              console.warn(`[Delete] Card ${id} not found in ${dateKey}. Searching all dates...`);
              for (const key of Object.keys(state.cards)) {
                if (deleteCardFromState(key, id)) {
                  console.log(`[Delete] Found and deleted card ${id} from ${key}`);
                  // ë§Œì•½ ë‹¤ë¥¸ ë‚ ì§œì—ì„œ ì§€ì›Œì¡Œë‹¤ë©´, ê·¸ ë‚ ì§œì˜ ë±ƒì§€ë„ ì—…ë°ì´íŠ¸ í•´ì•¼ í•¨
                  updateDayBadge(key);
                  deleted = true;
                  break;
                }
              }
            }

            if (!deleted) {
              console.error(`[Delete] Failed to delete card ${id} from state.`);
            }
          }
          updateDayBadge(dateKey); // ì‚­ì œ ì‹œ ë±ƒì§€ ì—…ë°ì´íŠ¸
        }
        if (parent && parent.classList.contains("day-body")) {
          if (!parent.querySelector(".card")) {
            const hint = parent.querySelector(".day-empty-hint");
            if (hint) hint.style.display = "block";
          }
        }
      });

      btnColor.addEventListener("click", (e) => {
        e.stopPropagation();
        const currentColor = card.dataset.color || "default";
        const idx = CARD_COLORS.indexOf(currentColor);
        const nextColor = CARD_COLORS[(idx + 1 + CARD_COLORS.length) % CARD_COLORS.length];
        card.dataset.color = nextColor;
        applyCardColorClass(card, nextColor);
        syncOneCardFromDom(card);
      });

      // ë“œë˜ê·¸ ì´ë™
      card.draggable = true;
      card.addEventListener("dragstart", (e) => {
        // ì„ íƒë˜ì§€ ì•Šì€ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•˜ë©´ ê¸°ì¡´ ì„ íƒ í•´ì œí•˜ê³  ì´ ì¹´ë“œë§Œ ì„ íƒ
        if (!card.classList.contains("selected")) {
          clearSelection();
          toggleSelection(card);
        }

        // ì„ íƒëœ ëª¨ë“  ì¹´ë“œ ìˆ˜ì§‘
        draggingCards = Array.from(document.querySelectorAll(".card.selected"));

        // ì•ˆì „ì¥ì¹˜: ë§Œì•½ í˜„ì¬ ì¹´ë“œê°€ ì„ íƒ ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´(ìœ„ ë¡œì§ìƒ ê·¸ëŸ´ë¦¬ ì—†ì§€ë§Œ) ì¶”ê°€
        if (!draggingCards.includes(card)) {
          draggingCards.push(card);
        }

        e.dataTransfer.effectAllowed = "move";
        // ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œë“¤ íˆ¬ëª…ë„ ì¡°ì ˆ
        setTimeout(() => {
          draggingCards.forEach(c => c.style.opacity = "0.4");
        }, 0);
      });

      card.addEventListener("dragend", () => {
        if (draggingCards) {
          draggingCards.forEach(c => c.style.opacity = "1");
        }
        draggingCards = [];

        const targets = document.querySelectorAll(".day-cell.drop-target");
        targets.forEach(c => c.classList.remove("drop-target"));
        if (dragPlaceholder && dragPlaceholder.parentElement) {
          dragPlaceholder.parentElement.removeChild(dragPlaceholder);
        }
        dragPlaceholder = null;
      });

      return card;
    }

    function renderCalendar() {
      calendarGrid.innerHTML = "";

      const viewYear = current.getFullYear();
      const viewMonth = current.getMonth();

      // ì˜¤ëŠ˜ ë‚ ì§œ(ì‹œê°„ 0ì‹œë¡œ ì •ê·œí™”)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      updateMonthTitle();

      const monthKey = formatMonthKey(viewYear, viewMonth);
      const monthVisibility = state.weekVisibility[monthKey] || [];

      // ê¸°ì¤€: í˜„ì¬ ë‹¬ì˜ 1ì¼ ~ ë§ì¼
      const firstOfMonth = new Date(viewYear, viewMonth, 1);
      const lastOfMonth = new Date(viewYear, viewMonth + 1, 0);

      // í˜„ì¬ ë‹¬ê³¼ ê²¹ì¹˜ëŠ” ì²« ì£¼ì˜ "ì‹œì‘ ì¼"(ì¼ìš”ì¼)
      const firstWeekStart = new Date(firstOfMonth);
      const firstWeekday = firstWeekStart.getDay(); // 0(ì¼)~6(í† )
      firstWeekStart.setDate(firstWeekStart.getDate() - firstWeekday);

      // í˜„ì¬ ë‹¬ê³¼ ê²¹ì¹˜ëŠ” ë§ˆì§€ë§‰ ì£¼ì˜ "ë ì¼"(í† ìš”ì¼)
      const lastWeekEnd = new Date(lastOfMonth);
      const lastWeekday = lastWeekEnd.getDay();
      lastWeekEnd.setDate(lastWeekEnd.getDate() + (6 - lastWeekday));

      // ê¸°ì¤€ ì£¼ ì•ë’¤ë¡œ 2ì£¼(14ì¼)ì”© í™•ì¥
      const startDate = new Date(firstWeekStart);
      startDate.setDate(startDate.getDate() - 14);

      const endDate = new Date(lastWeekEnd);
      endDate.setDate(endDate.getDate() + 14);

      const MS_PER_DAY = 24 * 60 * 60 * 1000;
      const totalDays = Math.round((endDate - startDate) / MS_PER_DAY) + 1;
      const totalWeeks = Math.ceil(totalDays / 7);

      for (let rowIndex = 0; rowIndex < totalWeeks; rowIndex++) {
        const weekRow = document.createElement("div");
        weekRow.className = "week-row";

        const weekHeader = document.createElement("div");
        weekHeader.className = "week-row-header";
        const weekTitle = document.createElement("div");
        weekTitle.className = "week-row-title";

        const weekBody = document.createElement("div");
        weekBody.className = "week-row-body";

        let containsToday = false;

        // ì´ ì£¼ì— í¬í•¨ëœ ì‹¤ì œ ë‚ ì§œ ë²”ìœ„ (ì£¼ ì œëª©ì— í‘œì‹œìš©)
        let weekStartDate = null;
        let weekEndDate = null;

        // ì´ ì£¼ê°€ í˜„ì¬ ì„ íƒëœ ë‹¬(viewMonth)ì˜ ë‚ ì§œë¥¼ í•˜ë‚˜ë¼ë„ í¬í•¨í•˜ëŠ”ì§€
        let weekHasCurrentMonth = false;

        for (let col = 0; col < 7; col++) {
          const cell = document.createElement("div");
          cell.className = "day-cell";

          const header = document.createElement("div");
          header.className = "day-header";
          const numEl = document.createElement("div");
          numEl.className = "day-number";
          const metaEl = document.createElement("div");
          metaEl.className = "day-meta";

          const body = document.createElement("div");
          body.className = "day-body";
          const hint = document.createElement("div");
          hint.className = "day-empty-hint";
          hint.textContent = "ë”ë¸”í´ë¦­í•´ì„œ ì¹´ë“œ ì¶”ê°€";
          body.appendChild(hint);

          // ì´ë²ˆ ì…€ì˜ ì‹¤ì œ ë‚ ì§œ = startDate + (rowIndex * 7 + col)
          const thisDate = new Date(startDate);
          thisDate.setDate(startDate.getDate() + rowIndex * 7 + col);

          // í˜„ì¬ ì„ íƒëœ ë‹¬ì¸ì§€ ì—¬ë¶€ì— ë”°ë¼ ì…€/ì£¼ ìŠ¤íƒ€ì¼ í”Œë˜ê·¸ ì„¤ì •
          if (thisDate.getMonth() !== viewMonth) {
            cell.classList.add("other-month");
          } else {
            weekHasCurrentMonth = true;
          }

          // ì£¼ì˜ ì‹œì‘/ë ë‚ ì§œ ì¶”ì 
          if (!weekStartDate) {
            weekStartDate = new Date(thisDate);
            weekEndDate = new Date(thisDate);
          } else {
            if (thisDate < weekStartDate) weekStartDate = new Date(thisDate);
            if (thisDate > weekEndDate) weekEndDate = new Date(thisDate);
          }

          const w = thisDate.getDay();
          const dayOfMonth = thisDate.getDate();

          numEl.textContent = `${dayOfMonth}(${weekdayNames[w]})`;
          if (w === 0) numEl.classList.add("sun");
          else if (w === 6) numEl.classList.add("sat");

          const key = formatDateKey(thisDate);
          cell.dataset.date = key;

          // ì˜¤ëŠ˜ í‘œì‹œ
          const cmp = new Date(thisDate.getTime());
          cmp.setHours(0, 0, 0, 0);
          if (cmp.getTime() === today.getTime()) {
            cell.classList.add("today");
            metaEl.textContent = "ì˜¤ëŠ˜";
            containsToday = true;
          }

          const cards = getCardsForDate(key);
          if (cards.length > 0) hint.style.display = "none";
          cards.forEach(data => {
            createCard(body, data, { autoEdit: false, fromState: true });
          });
          // ë Œë”ë§ ì§í›„ ë±ƒì§€ ê°±ì‹ 
          updateDayBadge(key);

          header.appendChild(numEl);
          header.appendChild(metaEl);
          cell.appendChild(header);
          cell.appendChild(body);
          weekBody.appendChild(cell);

          // ë‚ ì§œ ë”ë¸”í´ë¦­ â†’ ìƒˆ ì¹´ë“œ
          cell.addEventListener("dblclick", () => {
            if (!cell.dataset.date) return;
            createCard(body, { text: "", done: false, color: "default" }, { autoEdit: true, fromState: false });
            // ìƒì„± ì‹œ ë±ƒì§€ ì—…ë°ì´íŠ¸
            updateDayBadge(cell.dataset.date);
          });

          // ë“œë˜ê·¸ ì´ë™ ì²˜ë¦¬
          cell.addEventListener("dragover", (e) => {
            if (!draggingCards || draggingCards.length === 0) return;
            e.preventDefault();

            const allCells = document.querySelectorAll(".day-cell.drop-target");
            allCells.forEach(c => c.classList.remove("drop-target"));
            cell.classList.add("drop-target");

            const bodyEl = cell.querySelector(".day-body");
            if (!bodyEl) return;

            if (!dragPlaceholder) {
              dragPlaceholder = document.createElement("div");
              dragPlaceholder.className = "card-placeholder";
              // ì—¬ëŸ¬ ê°œ ë“œë˜ê·¸ ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ë†’ì´ ì¡°ì • (ì„ íƒ ì‚¬í•­, ì—¬ê¸°ì„  ê¸°ë³¸ê°’ ìœ ì§€)
            }

            const cardsInBody = Array.from(bodyEl.querySelectorAll(".card"));
            // ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œë“¤ì€ ì œì™¸í•˜ê³  ìœ„ì¹˜ ê³„ì‚°
            const filtered = cardsInBody.filter(c => !draggingCards.includes(c));

            if (filtered.length === 0) {
              if (dragPlaceholder.parentElement !== bodyEl) {
                bodyEl.appendChild(dragPlaceholder);
              }
              return;
            }

            const mouseY = e.clientY;
            let inserted = false;
            for (const cardEl of filtered) {
              const rect = cardEl.getBoundingClientRect();
              const midY = rect.top + rect.height / 2;
              if (mouseY < midY) {
                if (dragPlaceholder.parentElement !== bodyEl || dragPlaceholder.nextSibling !== cardEl) {
                  bodyEl.insertBefore(dragPlaceholder, cardEl);
                }
                inserted = true;
                break;
              }
            }

            if (!inserted) {
              if (dragPlaceholder.parentElement !== bodyEl || dragPlaceholder.nextSibling != null) {
                bodyEl.appendChild(dragPlaceholder);
              }
            }
          });

          cell.addEventListener("drop", (e) => {
            e.preventDefault();
            if (!draggingCards || draggingCards.length === 0 || !cell.dataset.date) return;

            const newKey = cell.dataset.date;
            const bodyEl = cell.querySelector(".day-body");
            if (!bodyEl) return;

            // 1. DOM ì´ë™
            // draggingCardsë¥¼ ìˆœì„œëŒ€ë¡œ placeholder ìœ„ì¹˜ì— ì‚½ì…
            if (dragPlaceholder && dragPlaceholder.parentElement === bodyEl) {
              draggingCards.forEach(c => bodyEl.insertBefore(c, dragPlaceholder));
            } else {
              draggingCards.forEach(c => bodyEl.appendChild(c));
            }

            // 2. ë°ì´í„° ì—…ë°ì´íŠ¸
            const affectedDateKeys = new Set();
            affectedDateKeys.add(newKey);

            draggingCards.forEach(card => {
              const oldKey = card.dataset.date;
              if (oldKey) affectedDateKeys.add(oldKey);

              card.dataset.date = newKey; // DOM ì—…ë°ì´íŠ¸

              // State ì—…ë°ì´íŠ¸
              if (oldKey && oldKey !== newKey) {
                const idStr = card.dataset.cardId;
                const id = Number(idStr);
                if (Number.isFinite(id)) {
                  // ê¸°ì¡´ ë‚ ì§œì—ì„œ ì œê±°
                  const oldList = getCardsForDate(oldKey);
                  const idx = oldList.findIndex(c => c.id === id);
                  let obj = null;
                  if (idx >= 0) {
                    obj = oldList.splice(idx, 1)[0];
                    if (oldList.length === 0) delete state.cards[oldKey];
                  }

                  // ìƒˆ ë‚ ì§œì— ì¶”ê°€
                  if (obj) {
                    const newList = ensureCardList(newKey);
                    newList.push(obj);
                  }
                }
              }
            });

            saveState();

            // 3. UI ì—…ë°ì´íŠ¸ (ë±ƒì§€, íŒíŠ¸)
            affectedDateKeys.forEach(key => {
              updateDayBadge(key);
              // íŒíŠ¸ ì²˜ë¦¬
              const cellEl = document.querySelector(`.day-cell[data-date="${key}"]`);
              if (cellEl) {
                const bEl = cellEl.querySelector(".day-body");
                if (bEl) {
                  const h = bEl.querySelector(".day-empty-hint");
                  const hasCards = bEl.querySelector(".card");
                  if (h) h.style.display = hasCards ? "none" : "block";
                }
              }
            });

            // ë“œë¡­ íƒ€ê²Ÿ ì •ë¦¬
            const targets = document.querySelectorAll(".day-cell.drop-target");
            targets.forEach(c => c.classList.remove("drop-target"));

            if (dragPlaceholder && dragPlaceholder.parentElement) {
              dragPlaceholder.parentElement.removeChild(dragPlaceholder);
            }
            dragPlaceholder = null;
            draggingCards = []; // ë“œë¡­ í›„ ì„ íƒ ìƒíƒœ ìœ ì§€ëŠ” ìš”êµ¬ì‚¬í•­ì— ëª…ì‹œ ì—†ìœ¼ë‚˜, ë³´í†µ ë“œë¡­ í›„ì—” ì„ íƒ í•´ì œí•˜ê±°ë‚˜ ìœ ì§€í•¨. 
            // "ë“œë¡­ì´ ì™„ë£Œë˜ë©´... ê° ì¹´ë“œì˜ dataset.dateì™€ state.cards ê°±ì‹ "
            // "renderCalendar í˜¸ì¶œ ì‹œ ì´ˆê¸°í™”" -> ì—¬ê¸°ì„  renderCalendar í˜¸ì¶œ ì•ˆí•¨ (DOM ì´ë™ë§Œ í•¨)
            // ì‚¬ìš©ì ê²½í—˜ìƒ ë“œë¡­ í›„ì—ë„ ì„ íƒ ìœ ì§€ë˜ëŠ”ê²Œ ì—°ì† ì‘ì—…ì— ì¢‹ìŒ. ì¼ë‹¨ ìœ ì§€.
          });
        }

        if (containsToday) {
          weekRow.classList.add("current-week");
        }

        // ì£¼ ì œëª©ì„ ë‚ ì§œ ë²”ìœ„ë¡œ í‘œì‹œ (ì˜ˆ: 11ì›” 3ì¼~9ì¼, 11ì›” 27ì¼~12ì›” 3ì¼)
        if (weekStartDate && weekEndDate) {
          const sM = weekStartDate.getMonth();
          const sD = weekStartDate.getDate();
          const eM = weekEndDate.getMonth();
          const eD = weekEndDate.getDate();
          if (sM === eM) {
            weekTitle.textContent = `${sM + 1}ì›” ${sD}ì¼~${eD}ì¼`;
          } else {
            weekTitle.textContent = `${sM + 1}ì›” ${sD}ì¼~${eM + 1}ì›” ${eD}ì¼`;
          }
        } else {
          weekTitle.textContent = "";
        }

        // í˜„ì¬ ë‹¬ì— ì†í•˜ëŠ” ì£¼ / ì™„ì „ ë²„í¼ ì£¼ ìŠ¤íƒ€ì¼ êµ¬ë¶„
        if (weekHasCurrentMonth) {
          weekRow.classList.add("week-row-main");
        } else {
          weekRow.classList.add("week-row-outside");
        }

        let isCollapsed;
        const savedVis = monthVisibility[rowIndex];
        if (savedVis === true) isCollapsed = false;
        else if (savedVis === false) isCollapsed = true;
        else isCollapsed = !containsToday; // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ í¬í•¨ëœ ì£¼ë§Œ í¼ì¹¨

        if (isCollapsed) {
          weekRow.classList.add("collapsed");
        }

        // ì£¼ë³„ ì ‘ê¸°/í¼ì¹˜ê¸°: ì£¼ í—¤ë” í´ë¦­
        weekHeader.addEventListener("click", () => {
          const monthKeyLocal = monthKey;
          const row = rowIndex;
          const currentlyCollapsed = weekRow.classList.contains("collapsed");
          if (!state.weekVisibility[monthKeyLocal]) {
            state.weekVisibility[monthKeyLocal] = [];
          }
          if (currentlyCollapsed) {
            weekRow.classList.remove("collapsed");
            state.weekVisibility[monthKeyLocal][row] = true;
          } else {
            weekRow.classList.add("collapsed");
            state.weekVisibility[monthKeyLocal][row] = false;
          }
          saveState();
        });

        weekHeader.appendChild(weekTitle);
        weekRow.appendChild(weekHeader);
        weekRow.appendChild(weekBody);
        calendarGrid.appendChild(weekRow);

        // ì£¼ ìƒì„± í›„ ë±ƒì§€ ì´ˆê¸° ì—…ë°ì´íŠ¸ (ëª¨ë“  ì…€ì´ ì¶”ê°€ëœ í›„ í•´ì•¼ ì •í™•í•˜ì§€ë§Œ, 
        // ì—¬ê¸°ì„œëŠ” ì•„ì§ ì…€ì´ ì¶”ê°€ë˜ê¸° ì „ì„. weekBodyì— ì…€ì„ ì¶”ê°€í•˜ëŠ” ë£¨í”„ê°€ ë’¤ì— ìˆìŒ.
        // ë”°ë¼ì„œ ë£¨í”„ê°€ ëë‚œ ë’¤ì— í˜¸ì¶œí•´ì•¼ í•¨.)
        // -> ìˆ˜ì •: weekBodyì— cellì„ appendí•˜ëŠ” ë£¨í”„ëŠ” ì´ ì½”ë“œ ë¸”ë¡ *ë‚´ë¶€*ê°€ ì•„ë‹ˆë¼ *ë’¤*ê°€ ì•„ë‹ˆë¼ *ì•ˆ*ì— ìˆìŒ.
        // í˜„ì¬ ì½”ë“œ êµ¬ì¡°:
        // for (rowIndex) {
        //   create weekRow...
        //   for (col) { create cell... append to weekBody }
        //   append weekBody to weekRow...
        // }

        // ë”°ë¼ì„œ for(col) ë£¨í”„ê°€ ëë‚œ ì§í›„, weekRowê°€ ì™„ì„±ëœ ì‹œì ì— updateWeekBadge í˜¸ì¶œí•˜ë©´ ë¨.

        // í•˜ì§€ë§Œ ìœ„ ì½”ë“œëŠ” weekHeader ìƒì„± ë¶€ë¶„ì„. 
        // col ë£¨í”„ëŠ” ì´ ì½”ë“œ *ë’¤*ê°€ ì•„ë‹ˆë¼ *ì•*ë„ ì•„ë‹ˆê³ ... 
        // renderCalendar ì „ì²´ êµ¬ì¡°ë¥¼ ë‹¤ì‹œ ë´ì•¼í•¨.

        // renderCalendar êµ¬ì¡°:
        // for (rowIndex) {
        //   create weekRow, header, body...
        //   for (col) { ... create cell ... weekBody.appendChild(cell) }
        //   ...
        //   weekRow.appendChild(header)
        //   weekRow.appendChild(body)
        //   calendarGrid.appendChild(weekRow)
        // }

        // ê·¸ëŸ¬ë¯€ë¡œ col ë£¨í”„ê°€ ëë‚œ ë’¤, weekRowë¥¼ calendarGridì— ë¶™ì´ê¸° ì§ì „ì— updateWeekBadgeë¥¼ í˜¸ì¶œí•˜ë©´ ë¨.
        // í˜„ì¬ ReplacementContentëŠ” weekHeader ìƒì„± ë° append ë¶€ë¶„ì„.
        // ì´ ë¶€ë¶„ì€ col ë£¨í”„ *ì´ì „*ì— ìœ„ì¹˜í•¨ (ì›ë˜ ì½”ë“œìƒ).
        // ë”°ë¼ì„œ ì—¬ê¸°ì„œ badgeë¥¼ ìƒì„±í•´ì„œ headerì— ë¶™ì—¬ë‘ê³ ,
        // col ë£¨í”„ê°€ ëë‚œ ë’¤ì— updateWeekBadgeë¥¼ í˜¸ì¶œí•´ì•¼ í•¨.

        // ê¸°ì¡´ ì½”ë“œ ìœ„ì¹˜ í™•ì¸:
        // weekHeader ìƒì„± -> col ë£¨í”„ -> weekRow ì¡°ë¦½.
        // ë‚´ê°€ ì§€ê¸ˆ ìˆ˜ì •í•˜ë ¤ëŠ” ë¶€ë¶„ì€ weekRow ì¡°ë¦½ ë¶€ë¶„ (Line 1327 ê·¼ì²˜).
        // ì´ ë¶€ë¶„ì€ col ë£¨í”„ê°€ *ëë‚œ ë’¤*ì— ìˆìŒ. (Line 1200~1300 ì‚¬ì´ê°€ col ë£¨í”„ì¼ ê²ƒì„)
        // í™•ì¸í•´ë³´ì.

        // view_fileë¡œ í™•ì¸í•œ ë°”ì— ë”°ë¥´ë©´:
        // Line 1200~1300: col ë£¨í”„ ë° cell ìƒì„± ë¡œì§.
        // Line 1309: weekHeader click listener.
        // Line 1327: weekHeader.appendChild(weekTitle); ...

        // ë§ìŒ. ì´ ë¶€ë¶„ì€ col ë£¨í”„ê°€ ëë‚œ ë’¤ì„.
        // ê·¸ëŸ¬ë¯€ë¡œ ì—¬ê¸°ì„œ updateWeekBadge í˜¸ì¶œ ê°€ëŠ¥.
      }
    }

    const scopeMonthBtn = document.getElementById("scopeMonth");
    const scopeAllBtn = document.getElementById("scopeAll");
    const toastContainer = document.getElementById("toastContainer");

    let searchMode = "month"; // "month" | "all"

    function switchSearchScope(mode) {
      searchMode = mode;
      if (mode === "month") {
        scopeMonthBtn.classList.add("active");
        scopeAllBtn.classList.remove("active");
        searchInput.placeholder = "ì´ ë‹¬ì—ì„œ ê²€ìƒ‰";
      } else {
        scopeMonthBtn.classList.remove("active");
        scopeAllBtn.classList.add("active");
        searchInput.placeholder = "ì „ì²´ ê¸°ê°„ ê²€ìƒ‰";
      }
      searchInput.focus();
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = "toast-out 0.3s ease forwards";
        toast.addEventListener("animationend", () => {
          toast.remove();
        });
      }, 3000);
    }

    function clearSearchHighlights() {
      document.querySelectorAll(".card.search-hit").forEach(c => {
        c.classList.remove("search-hit");
      });
      searchInput.classList.remove("error");
    }

    function highlightCard(card) {
      card.classList.add("search-hit");
      card.scrollIntoView({ behavior: "smooth", block: "center" });
      setTimeout(() => {
        card.classList.remove("search-hit");
      }, 4000);
    }

    function runSearch() {
      const q = searchInput.value.trim().toLowerCase();
      clearSearchHighlights();

      if (!q) return;

      if (searchMode === "month") {
        // (A) ì´ë²ˆ ë‹¬ ê²€ìƒ‰ (DOM ê¸°ì¤€)
        const cards = Array.from(document.querySelectorAll(".card"));
        let found = null;
        for (const card of cards) {
          const text = card.innerText.toLowerCase();
          if (text.includes(q)) { found = card; break; }
        }

        if (found) {
          highlightCard(found);
        } else {
          handleSearchFail();
        }

      } else {
        // (B) ì „ì²´ ê¸°ê°„ ê²€ìƒ‰ (State ê¸°ì¤€)
        let foundDateKey = null;
        let foundCardId = null;

        // ë‚ ì§œ í‚¤ ì •ë ¬ (ìµœì‹ ìˆœ or ê³¼ê±°ìˆœ? ìš”êµ¬ì‚¬í•­: "ê°€ì¥ ìµœê·¼ í˜¹ì€ ê°€ì¥ ì²« ë²ˆì§¸" -> ì—¬ê¸°ì„  ë‚ ì§œìˆœ ì •ë ¬ í›„ ì²«ë²ˆì§¸ë¡œ í•¨)
        // ìš”êµ¬ì‚¬í•­ ì¬í™•ì¸: "ë§¤ì¹­ëœ ë‚ ì§œ ì¤‘ ê°€ì¥ ìµœê·¼ í˜¹ì€ ê°€ì¥ ì²« ë²ˆì§¸ ë‚ ì§œ" -> ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì˜¤ë¦„ì°¨ìˆœ(ê³¼ê±°->ë¯¸ë˜) ì²«ë²ˆì§¸ ë°œê²¬ìœ¼ë¡œ êµ¬í˜„
        // í˜¹ì€ Object.keys ìˆœì„œëŠ” ë³´ì¥ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì •ë ¬ í•„ìš”.
        const dateKeys = Object.keys(state.cards).sort();

        for (const key of dateKeys) {
          const list = state.cards[key];
          if (!Array.isArray(list)) continue;
          const match = list.find(c => (c.text || "").toLowerCase().includes(q));
          if (match) {
            foundDateKey = key;
            foundCardId = match.id;
            break;
          }
        }

        if (foundDateKey && foundCardId) {
          // í•´ë‹¹ ë‚ ì§œë¡œ ì´ë™
          const [y, m, d] = foundDateKey.split("-").map(Number);
          current = new Date(y, m - 1, 1); // í•´ë‹¹ ë‹¬ 1ì¼ë¡œ ì„¤ì •
          renderCalendar(); // ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¬ê¸°

          // DOMì—ì„œ ì¹´ë“œ ì°¾ê¸°
          // renderCalendar ì§í›„ì—ëŠ” DOMì´ ìƒì„±ë¨.
          // ì•½ê°„ì˜ ì§€ì—°ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬ë¨.
          setTimeout(() => {
            const targetCard = document.querySelector(`.card[data-card-id="${foundCardId}"]`);
            if (targetCard) {
              highlightCard(targetCard);
            }
          }, 50); // ë Œë”ë§ ì•ˆì •í™” ì•ˆì „ì¥ì¹˜
        } else {
          handleSearchFail();
        }
      }
    }

    function handleSearchFail() {
      searchInput.classList.add("error");
      showToast("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
      setTimeout(() => {
        searchInput.classList.remove("error");
      }, 1500);
    }

    // ===== Airtable ì—°ë™ ë¡œì§ =====
    function ensureAirtableConfig() {
      if (!AIRTABLE_BASE_ID || !AIRTABLE_TABLE_NAME) {
        alert("Airtable ì„¤ì •(Base ID / Table Name)ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return false;
      }
      if (!AIRTABLE_TOKEN || AIRTABLE_TOKEN.includes("ì—¬ê¸°ì—_ë„¤_Airtable_í† í°_ë¶™ì—¬ë„£ê¸°")) {
        alert("Airtable í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. pat... í† í°ì„ AIRTABLE_TOKENì— ë„£ì–´ì£¼ì„¸ìš”.");
        return false;
      }
      return true;
    }

    async function saveToAirtableSnapshot() {
      if (!ensureAirtableConfig()) return;
      try {
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`;
        const snapshotName = new Date().toISOString().slice(0, 19).replace("T", " ");
        const snapshotJson = JSON.stringify(state);

        // Airtable Web APIëŠ” create ì‹œ body ì•ˆì— "records" ë°°ì—´ì„ ìš”êµ¬í•¨
        const res = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${AIRTABLE_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            records: [
              {
                fields: {
                  cardID: snapshotName,
                  json: snapshotJson
                }
              }
            ]
          })
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("[Airtable] save error", res.status, res.statusText, text);
          alert(`ì—ì–´í…Œì´ë¸” ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ${res.status})`);
          return;
        }

        alert("ì—ì–´í…Œì´ë¸”ì— ìŠ¤ëƒ…ìƒ· ì €ì¥ ì™„ë£Œ!");
      } catch (e) {
        console.error("saveToAirtableSnapshot error", e);
        alert("ì—ì–´í…Œì´ë¸” ì €ì¥ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    async function loadFromAirtableSnapshot() {
      if (!ensureAirtableConfig()) return;
      try {
        const url =
          `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}` +
          `?maxRecords=1&sort[0][field]=createdTime&sort[0][direction]=desc`;

        const res = await fetch(url, {
          headers: {
            Authorization: `Bearer ${AIRTABLE_TOKEN}`
          }
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("[Airtable] load error", res.status, res.statusText, text);
          alert("ì—ì–´í…Œì´ë¸”ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }

        const data = await res.json();
        if (!data.records || data.records.length === 0) {
          alert("ì—ì–´í…Œì´ë¸”ì— ì €ì¥ëœ ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const latest = data.records[0];
        const rawJson = latest.fields.json;
        if (!rawJson) {
          alert("ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ·ì— json í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const parsed = JSON.parse(rawJson);
        if (!parsed || typeof parsed !== "object" || !parsed.cards || typeof parsed.nextId !== "number") {
          alert("ìŠ¤ëƒ…ìƒ· êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
          return;
        }

        state = parsed;
        saveState();
        renderCalendar();
        alert("ì—ì–´í…Œì´ë¸” ìŠ¤ëƒ…ìƒ·ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
      } catch (e) {
        console.error("loadFromAirtableSnapshot error", e);
        alert("ì—ì–´í…Œì´ë¸”ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    // ===== ì´ˆê¸°í™” =====
    window.addEventListener("DOMContentLoaded", () => {
      // ... (ê¸°ì¡´ ì½”ë“œ)


      // ... (ê¸°ì¡´ ì½”ë“œ)
      loadState();
      renderCalendar();

      prevBtn.addEventListener("click", () => {
        syncCurrentMonthFromDom();
        current.setMonth(current.getMonth() - 1);
        renderCalendar();
      });
      nextBtn.addEventListener("click", () => {
        syncCurrentMonthFromDom();
        current.setMonth(current.getMonth() + 1);
        renderCalendar();
      });

      // ì˜¤ëŠ˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      if (todayBtn) {
        todayBtn.addEventListener("click", () => {
          syncCurrentMonthFromDom();
          const now = new Date();
          current = new Date(now.getFullYear(), now.getMonth(), 1);
          renderCalendar();
          const currentWeekEl = document.querySelector(".week-row.current-week");
          if (currentWeekEl) {
            currentWeekEl.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }

      backupBtn.addEventListener("click", () => {
        try {
          const dataStr = JSON.stringify(state, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          const now = new Date();
          const y = now.getFullYear();
          const m = String(now.getMonth() + 1).padStart(2, "0");
          const d = String(now.getDate());
          a.href = url;
          a.download = `muchi-note-safe-${y}${m}${d}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error("ë°±ì—… ì˜¤ë¥˜", e);
          alert("ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ê²€ìƒ‰ ìŠ¤ì½”í”„ ë²„íŠ¼ ì´ë²¤íŠ¸
      scopeMonthBtn.addEventListener("click", () => switchSearchScope("month"));
      scopeAllBtn.addEventListener("click", () => switchSearchScope("all"));

      searchBtn.addEventListener("click", runSearch);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runSearch();
      });

      if (monthPickerToggle) {
        monthPickerToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleMonthDropdown();
        });
      }
      document.addEventListener("click", (e) => {
        // ë¹ˆ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
        // .card ë‚´ë¶€ í´ë¦­ì´ë‚˜ .month-picker ë‚´ë¶€ í´ë¦­ ë“±ì€ ì œì™¸
        if (e.target.closest(".card")) return;
        if (e.target.closest(".month-picker")) return; // ë‹¬ë ¥ í”¼ì»¤ ë‹«ê¸° ë¡œì§ê³¼ ì¶©ëŒ ë°©ì§€
        clearSelection();

        if (!monthDropdown || !monthPickerToggle) return;
        if (!monthDropdown.classList.contains("open")) return;
        const target = e.target;
        const picker = monthPickerToggle.closest(".month-picker");
        if (picker && picker.contains(target)) return;
        closeMonthDropdown();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          clearSelection();
        }
      });

      if (ymPrevYear && ymNextYear) {
        ymPrevYear.addEventListener("click", () => {
          pickerYear--;
          if (ymYearLabel) ymYearLabel.textContent = `${pickerYear}ë…„`;
        });
        ymNextYear.addEventListener("click", () => {
          pickerYear++;
          if (ymYearLabel) ymYearLabel.textContent = `${pickerYear}ë…„`;
        });
      }

      if (ymMonthButtons && ymMonthButtons.length) {
        ymMonthButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            const monthIndex = Number(btn.dataset.month);
            if (!Number.isFinite(monthIndex)) return;
            current.setFullYear(pickerYear);
            current.setMonth(monthIndex);
            current.setDate(1);
            renderCalendar();
            closeMonthDropdown();
          });
        });
      }

      if (airtableSaveBtn) airtableSaveBtn.addEventListener("click", saveToAirtableSnapshot);
      if (airtableLoadBtn) airtableLoadBtn.addEventListener("click", loadFromAirtableSnapshot);

      // ë””ë²„ê·¸ìš©: ì½˜ì†”ì—ì„œ window._dumpState() í˜¸ì¶œí•˜ë©´ í˜„ì¬ state í™•ì¸ ê°€ëŠ¥
      window._dumpState = () => JSON.parse(JSON.stringify(state));
    });
  </script>
</body>

</html>